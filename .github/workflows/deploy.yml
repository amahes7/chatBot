name: Deploy GitHub Pages with OpenAI Proxy

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install express serverless-http dotenv

      - name: Generate proxy endpoint
        run: |
          mkdir -p dist
          cat <<EOL > dist/proxy.js
          const express = require('express');
          const fetch = require('node-fetch');
          const app = express();
          app.use(express.json());

          const OPENAI_API_KEY = process.env.OPENAI_API_KEY;

          app.post('/ask', async (req, res) => {
              try {
                  const prompt = req.body.prompt;
                  const r = await fetch('https://api.openai.com/v1/chat/completions', {
                      method: 'POST',
                      headers: {
                          'Content-Type': 'application/json',
                          'Authorization': 'Bearer ' + OPENAI_API_KEY
                      },
                      body: JSON.stringify({
                          model: 'gpt-3.5-turbo',
                          messages: [{role:'user', content: prompt}],
                          max_tokens: 500
                      })
                  });
                  const data = await r.json();
                  res.json(data);
              } catch(err) {
                  res.status(500).json({error: err.toString()});
              }
          });

          module.exports = app;
          EOL

      - name: Build static site (optional)
        run: cp -r * dist/

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          # Your page will be live at: https://username.github.io/repo/
